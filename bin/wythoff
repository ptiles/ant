#!/usr/bin/env bash

#set -e
set -o xtrace

PARALLEL="4"
DIR="results5/wythoff600k960mmp4"
STEPS="960_000_000%1_000_000"
PATTERN="7e-10"
ANT_ARGS="-p ${PATTERN} -m0 -rq -r [-9436320,6661856]#[5120,3200]*1024"

W="600000-850000%20000"
WA="B-D"

mkdir -p ${DIR}
open ${DIR}

merge () {
  find "${1}" -name "${2}" | xargs -n 256 | {  \
    sed 's/$/ -evaluate-sequence Max/';       \
    echo "-write ${3}";                       \
  } | magick -script -
}

./bin/ant-batch -wythoff "${W}" -wythoff-axes "${WA}"  \
| xargs -t -L1 -P "${PARALLEL}" -I{} \
  sh -c "./bin/ant -d ${DIR} -s ${STEPS} ${ANT_ARGS} {} || true"

for i in $(seq -w 1 960); do
  STEPS="${i}_000_000"
  merge "${DIR}" "RLL__${PATTERN}__*__${STEPS}.png" "${DIR}/Merged_RLL__${PATTERN}__${STEPS}.png"
  mv "${DIR}/RLL__${PATTERN}__"*"__${STEPS}.png" "${DIR}/RLL__${PATTERN}"
done

ffmpeg -framerate 24 -pattern_type glob                     \
       -i "${DIR}/Merged_RLL__${PATTERN}__*.png"            \
       -vf "scale=iw/2:ih/2, pad=ceil(iw/2)*2:ceil(ih/2)*2" \
       -c:v libx264 -pix_fmt yuv422p                        \
          "${DIR}/Merged_RLL__${PATTERN}.mp4"
