#!/usr/bin/env bash

#set -e
set -o xtrace

PARALLEL="${PARALLEL:="4"}"

NAME="${NAME:="RLL"}"
PATTERN="${PATTERN:="7e-06"}"
#IC="${IC:="4000"}"
#IO="${IO:="0-16000"}"
#MAX_STEPS="${MAX_STEPS:="100_000 200_000 500_000 1_000_000 2_000_000 5_000_000"}"
MAX_STEPS="${MAX_STEPS:="500_000 750_000 1_000_000 2_000_000"}"

ID="${ID:="kaleidoscope"}"

BASE="${NAME}_${PATTERN}_${ID}"
BASE_DIR="results5/${BASE}"

RECT="${RECT:="[0,0]#[5120,5120]*48"}"

#CROP="${CROP:="[1800,720]#[2560,1440]"}"
CROP="${CROP:="[2560,1440]"}"

#NOISE="-sm 35 -sn 75"
ANT_BASE_ARGS="-n ${NAME} -p ${PATTERN} -m -alpha -rq -r ${RECT} ${NOISE}"

merge () {
  find "${1}" -name "${2}" | xargs -n 50 | {  \
    sed 's/$/ -evaluate-sequence Max/';       \
    echo "-write ${3}";                       \
  } | magick -script -
}

open "${BASE_DIR}"

MAX_STEPS_ARRAY=($MAX_STEPS)
for STEPS in "${MAX_STEPS_ARRAY[@]}"; do
  DATE=$(date "+%Y-%m-%d_%H-%M-%S")
  DIR="${BASE_DIR}/${STEPS}_${DATE}"

#  BATCH_ARGS="-interval ${IO} -interval-count ${IC}"   \
#  BATCH_ARGS="-rect ${RECT} -rect-count ${IC}"        \
  BATCH_ARGS="-p 200 -grid ${RECT} -grid-size 13-16"        \
  ANT_ARGS="-d ${DIR} -s ${STEPS} ${ANT_BASE_ARGS}"   \
  X_ARGS="-P ${PARALLEL}" ./bin/xargs-ant-batch

  merge "${DIR}" "*.png" "${BASE_DIR}/Transparent_${STEPS}_${DATE}.png"

  mkdir -p "${BASE_DIR}/done"
  mv "${DIR}" "${BASE_DIR}/done"

  merge "${BASE_DIR}" "Transparent_*.png" "${BASE_DIR}/${BASE}_Transparent.png"

  magick "${BASE_DIR}/${BASE}_Transparent.png" -background black -alpha remove -alpha off -gamma 1.3 \
         "${BASE_DIR}/${BASE}_Black.png"
done

./bin/ant-crop -f "${BASE_DIR}/${BASE}_Black.png"  \
               -p "${BASE_DIR}/${BASE}_Crop" -g 15 \
               -r "${RECT}" -c "${CROP}" | bash -x
